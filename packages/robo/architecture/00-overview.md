# Robo.js Core Architecture Overview

This document provides a high-level overview of the Robo.js core architecture, serving as a reference for understanding how the framework operates.

## Package Structure

The core Robo.js package is located at `packages/robo/` and contains the following key directories:

```
packages/robo/
├── src/
│   ├── cli/                    # CLI commands and build tooling
│   │   ├── commands/           # CLI command implementations
│   │   │   ├── build/          # Build commands (robo, plugin)
│   │   │   ├── cloud/          # Cloud deployment commands
│   │   │   ├── add.ts          # Plugin installation
│   │   │   ├── dev.ts          # Development mode
│   │   │   ├── start.ts        # Production start
│   │   │   └── ...
│   │   ├── compiler/           # Build-time compilation
│   │   │   ├── build.ts        # TypeScript compilation via SWC
│   │   │   ├── manifest.ts     # Manifest loading utilities
│   │   │   ├── seed.ts         # Plugin seed file handling
│   │   │   └── typescript.ts   # TypeScript compiler options
│   │   └── utils/              # CLI utilities
│   │       ├── manifest.ts     # Manifest generation
│   │       ├── commands.ts     # Discord command registration
│   │       ├── compiler.ts     # Compiler facade
│   │       ├── generate-defaults.ts
│   │       ├── spirits.ts      # Worker thread management
│   │       └── ...
│   ├── core/                   # Runtime core functionality
│   │   ├── robo.ts             # Main Robo entry point
│   │   ├── config.ts           # Configuration loading
│   │   ├── portal.ts           # Handler collections
│   │   ├── handlers.ts         # Command/event execution
│   │   ├── globals.ts          # Global state registry
│   │   ├── flashcore.ts        # Persistent storage
│   │   ├── state.ts            # In-memory state management
│   │   ├── logger.ts           # Logging system
│   │   ├── env.ts              # Environment variable handling
│   │   ├── intents.ts          # Discord intent checking
│   │   └── ...
│   ├── default/                # Default handlers shipped with Robo
│   │   ├── commands/           # Default commands (/help, /dev/*)
│   │   └── events/             # Default events (ready, interactionCreate)
│   ├── internal/               # Internal utilities
│   │   ├── boot.ts             # Boot messages
│   │   └── nanocore.ts         # File-based IPC
│   ├── types/                  # TypeScript type definitions
│   │   ├── api.ts              # API route types
│   │   ├── commands.ts         # Command types
│   │   ├── config.ts           # Configuration types
│   │   ├── events.ts           # Event types
│   │   ├── manifest.ts         # Manifest types
│   │   └── common.ts           # Shared types
│   └── index.ts                # Public API exports
└── dist/                       # Compiled output
```

## Core Concepts

### 1. File-Based Routing

Robo.js uses a file-based routing convention where files placed in specific directories automatically become handlers:

| Directory | Purpose | Example |
|-----------|---------|---------|
| `/src/commands/` | Slash commands | `/src/commands/ping.ts` → `/ping` |
| `/src/events/` | Discord event handlers | `/src/events/messageCreate.ts` |
| `/src/api/` | HTTP API routes | `/src/api/health.ts` → `/api/health` |
| `/src/context/` | Context menu commands | `/src/context/user/info.ts` |
| `/src/middleware/` | Request middleware | Applied to all handlers |
| `/src/modules/` | Organized code modules | Grouping related handlers |

### 2. Manifest System

The manifest (`/.robo/manifest.json`) is the central registry that maps files to their runtime handlers:

- **Build-time**: Generated by scanning `/src` directories and importing handler configs
- **Runtime**: Loaded to populate the Portal with handler records
- **Plugin support**: Plugin manifests are merged into the project manifest

### 3. Plugin Architecture

Plugins extend Robo.js functionality through:

- **Registration**: Files in `/config/plugins/` register plugins with options
- **Manifest Merging**: Plugin handlers are merged into the project manifest
- **Lifecycle Hooks**: Plugins receive `_start`, `_stop`, `_restart` events
- **Seed Files**: Plugins can provide starter files copied to projects

### 4. Portal System

The Portal is the runtime registry providing access to all handlers:

```typescript
// Accessing handlers at runtime
portal.commands.get('ping')      // Get a command handler
portal.events.get('ready')       // Get event handlers
portal.apis.get('health')        // Get API route handler
portal.middleware                // Array of middleware handlers
```

## Main Entry Points

### Public API (`src/index.ts`)

Exports available to users of the `robo.js` package:

```typescript
export { Robo, client, portal } from './core/robo.js'
export { getConfig } from './core/config.js'
export { getPluginOptions } from './core/portal.js'
export { Flashcore } from './core/flashcore.js'
export { logger, Logger } from './core/logger.js'
export { getState, setState, State } from './core/state.js'
export { Mode } from './core/mode.js'
export { Env } from './core/env.js'
export { color, composeColors } from './core/color.js'
// ... types
```

### Runtime Entry (`src/core/robo.ts`)

The `Robo` object provides the main runtime API:

```typescript
export const Robo = { restart, start, stop, build }
export let client: Client        // Discord.js client instance
export const portal = new Portal()  // Handler registry
```

### CLI Entry (`src/cli/index.ts`)

The CLI dispatches to command handlers:

- `robo build` → `src/cli/commands/build/index.ts`
- `robo dev` → `src/cli/commands/dev.ts`
- `robo start` → `src/cli/commands/start.ts`
- `robo add` → `src/cli/commands/add.ts`

## Data Flow

### Build Flow

```
Source Files (/src)
       ↓
   Compilation (SWC)
       ↓
  Build Output (/.robo/build)
       ↓
  Manifest Generation
       ↓
  /.robo/manifest.json
       ↓
  Discord Command Registration (optional)
```

### Runtime Flow

```
Robo.start()
     ↓
Load Config + Manifest
     ↓
Portal.open() → Load all handlers
     ↓
Execute _start lifecycle events
     ↓
Create Discord Client
     ↓
Register event listeners
     ↓
Discord Login
```

### Request Handling Flow

```
Discord Interaction
        ↓
   InteractionCreate event
        ↓
   Determine handler type (command/context/autocomplete)
        ↓
   Execute middleware chain
        ↓
   Execute handler
        ↓
   Sage handles response (auto-defer, reply)
```

## Key Abstractions

### HandlerRecord

The standard structure for all handler types:

```typescript
interface HandlerRecord<T = unknown> {
  auto?: boolean           // Auto-generated by Robo
  description?: string     // Handler description
  handler: T               // The actual handler module
  key: string              // Unique identifier (e.g., "ping" or "user/info")
  module?: string          // Module name if from /modules
  path: string             // File path relative to build
  plugin?: {               // Plugin info if from a plugin
    name: string
    path: string
  }
  type: 'api' | 'command' | 'context' | 'event' | 'middleware'
}
```

### Manifest

The manifest structure containing all handler metadata:

```typescript
interface Manifest {
  __README: string
  __robo: {
    config: Config | null
    language: 'javascript' | 'typescript'
    mode: string
    type: 'plugin' | 'robo'
    version?: string
  }
  api: Record<string, ApiEntry>
  commands: Record<string, CommandEntry>
  context: {
    message: Record<string, ContextEntry>
    user: Record<string, ContextEntry>
  }
  events: Record<string, EventConfig[]>
  middleware?: MiddlewareEntry[]
  permissions?: PermissionsString[]
  scopes?: Scope[]
}
```

### Config

The project configuration structure:

```typescript
interface Config {
  clientOptions?: ClientOptions      // Discord.js client options
  plugins?: Plugin[]                 // Registered plugins
  defaults?: {                       // Default behaviors
    dev?: boolean
    help?: boolean
  }
  sage?: SageOptions                 // Auto-reply configuration
  timeouts?: {                       // Timeout settings
    lifecycle?: number
    commandDeferral?: number
  }
  // ... more options
}
```

## Globals System

The `Globals` object in `src/core/globals.ts` maintains global state accessible across the application:

```typescript
globalThis.robo = {
  config: null,                      // Loaded configuration
  flashcore: { _adapter: null },     // Storage adapter
  portal: {
    apis: null,                      // API handler collection
    commands: null,                  // Command handler collection
    context: null,                   // Context menu collection
    events: null,                    // Event handler collection
    middleware: [],                  // Middleware array
    moduleKeys: new Set()            // Active modules
  }
}
```

## Development Mode (Spirits)

During development, Robo.js uses worker threads ("Spirits") to enable hot reloading:

1. **Spirit Manager** (`src/cli/utils/spirits.ts`): Manages a pool of worker threads
2. **Spirit Worker** (`src/cli/spirit.ts`): Executes build/start/stop tasks
3. **Watcher**: Monitors file changes and triggers rebuilds
4. **State Transfer**: State is preserved across restarts

## Next Steps

For deeper understanding, see the following documents:

1. [Manifest System](./01-manifest-system.md) - How manifests are generated and loaded
2. [Plugin System](./02-plugin-system.md) - How plugins extend Robo.js
3. [Lifecycle Hooks](./03-lifecycle-hooks.md) - Event lifecycle and hooks
4. [Discord Integration](./04-discord-integration.md) - Discord.js coupling points
5. [File Routing](./05-file-routing.md) - File-based routing patterns
6. [Runtime Portal](./06-runtime-portal.md) - Handler access at runtime
7. [Build Process](./07-build-process.md) - Complete build pipeline
8. [Coupling Points](./08-coupling-points.md) - Discord.js dependencies summary

